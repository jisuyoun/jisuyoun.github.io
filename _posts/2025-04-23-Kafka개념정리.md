---
layout: single
title: "[Data] Kafka 개념 정리"
published: true
categories:
  - Data
tag:
  - Study
  - Kafka
---

# 1. Kafka란?

Kafka는 분산형 데이터 스트리밍 플랫폼 시스템으로, 실시간으로 기록 스트림을 게시, 구독, 저장 및 처리할 수 있는 분산형 데이터 스트리밍 플랫폼을 말한다.  

## 1.1. Kafka의 장점

- Kafka는 메모리 상에서 동작되어 시스템이 꺼질 경우 데이터가 유실되는 분산형 실시간 메시지 큐(MQTT)와 달리, 디스크에 저장되기 때문에 시스템이 다운되더라도 복구가 가능하다.
- 효과적인 대규모 트래픽 분산처리가 가능하다.
- Kafka Cluster 내 Zookeeper으로 인하여 안정적이다.

## 1.2. Kafka의 구성요소

😊 구성요소가 이해가 잘 되지 않는다면 밑에 있는 kafka 전반적인 흐름을 읽어보고 다시 보는 걸 추천 

![image](https://github.com/user-attachments/assets/0f2a98d5-ac11-48d0-89b5-ba8c7dee74f9)
출처: [여기어때 기술블로그, Apache Kafka를 사용하여 EDA 적용하기](https://techblog.gccompany.co.kr/apache-kafka%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-eda-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0-bf263c79efd0)

Kafka는 프로듀서, 컨슈머, 브로커, 토픽, 파티션, 주키퍼로 이루어져 있다.

💡 Kafka 2.8 이후에는 Zookeeper 없이도 운영할 수 있는 기능이 추가되었다.
{: .notice--primary}


### **1.2.1. 카프카 클러스터 (Kafka Cluster)**

- 카프카 클러스터는 처리할 데이터를 쌓아두는 데이터 저장소로 생각하면 된다.
- 카프카 클러스터에는 Zookeeper와 다수의 Broker로 이루어져 있다.

### **1.2.2. 프로듀서 (Producer)**

- 프로듀서는 **데이터를 생성하고 카프카 클러스터로 전송**한다.
- 이 데이터들은 토픽으로 구성되어 있다.

### **1.2.3. 토픽 (Topic)**

- 토픽은 **카프카에서 이루어지는 이벤트(=카테고리)를 뜻**한다.
- 토픽은 주제별로 이벤트를 모으는 단위 또는 이벤트를 분류하는 단위로 생각하면 된다.
- 각 토픽은 하나 이상의 파티션으로 설정되어있으며, **여러 개의 파티션으로 이루어져 있을 때 프로듀서가 여러 개일 경우 프로듀서는 규칙에 따라 각각의 파티션에 저장되게 되어 데이터 처리 속도가 빨라지는 장점**을 가질 수 있다.

### **1.2.4. 파티션 (Partition)**

- 파티션은 Kafka에서 데이터를 저장하고 분산하여 처리하는 단위로, 데이터의 안정성과 성능을 보장하며, 복제와 **병렬 처리**를 가능하게 한다.

### **1.2.5. 컨슈머 (Consumer)**

- 컨슈머는 각각의 파티션에서 데이터를 읽기 위해 카프카와 연결이 되며, **연결된 카프카에서 각각의 파티션에서 데이터를 읽은 후 다른 시스템으로 전달하거나 실시간 분석, 로그 처리 등 작업을 진행하는 역할**이다.
- 컨슈머는 그룹을 통해 여러 컨슈머가 동시에 데이터를 처리할 수 있으며, 읽은 데이터의 오프셋을 기록하여 자체적으로 읽어낸 위치를 추척하여 특정 위치로 돌아가 데이터를 읽어오거나 특정한 범위 내 데이터만을 읽어낼 수 있다.

💡 오프셋이란 동일한 오브젝트 안에서 오브젝트 처음부터 주어진 요소나 지점까지의 변위차를 나타내는 정수형을 말한다.
쉽게 생각하면 파티션 안에 1, 2, 3, 4…로 시퀀스들을 지정하고, 1번까지 읽었는지, 2번까지 읽었는지를 표현해주는 정수형이라고 생각하면 된다.
만약 **파티션에 100개의 데이터가 있는데, 오프셋이 100이라면 모든 데이터를 다 한 번씩 읽었다는 뜻**
{: .notice--primary}

### **1.2.6 브로커 (Broker)**

- 주키퍼와 함께 카프카 클러스터에서 운영과 유지보수를 담당하고 있다.
- 카프카 클러스터 내에서 데이터를 저장하고 관리하는 서버로, **프로듀서로부터 받은 데이터를 저장하여 컨슈머가 필요로 하는 데이터를 전달하는 역할을 하며, 데이터를을 안정적으로 보관하는 역할**을 한다.
- 카프카 클러스터는 여러 대의 브로커로 구성되어 있다.
- 카프카클러스터를 주키퍼와 여러 대의 브로커를 감싸고 있는 껍데기 정도로 생각하면 될 것 같다…!

### **1.2.7. 주키퍼 (Zookeeper)**

- 주키퍼는 분산 애플리케이션을 위한 코디네이션 시스템으로, 카프카 클러스터 구성정보와 상태를 관리하는 분산 형상 관리 도구를 말한다.
- 주키퍼는 카프카 클러스터의 구성 및 토픽의 메타데이터 관리, 컨슈머 그룹 등을 추적 및 유지, 분산 시스템 관리 역할을 맡고 있다.
- 즉, **카프카의 안정성과 일관성을 보장하는 역할**을 맡고 있다.

# 2. Kafka의 전체적인 흐름

1. 유저가 서버로 데이터를 보냄 (예를 들어 JSON 형태의 데이터)
2. 프로듀서가 유저가 보낸 데이터를 받아 특정 토픽으로 분류하여 클러스터의 브로커로 보냄
3. 클러스터 내 브로커가 프로듀서로부터 받은 데이터를 해당 토픽의 파티션에 저장함
4. 또 다른 유저가 서버로 특정 토픽의 데이터를 요청함
5. 컨슈머가 요청된 데이터의 토픽을 클러스터의 브로커에 요청함
6. 클러스터 내 브로커는 저장된 특정 토픽의 데이터를 컨슈머에게 전송함
7. 컨슈머는 전송받은 데이터를 유저에게 전송해줌
8. 유저는 해당 데이터를 가지고 실시간 분석, 로그 처리 등의 작업을 수행함

# 3. 토픽과 파티션

토픽과 파티션을 이해하기 위해 예를 들어 정리한다.

## 토픽과 파티션을 이해하기 위한 예시

1. 한 어플리케이션은 사용자의 로그인 기록, 사용자의 결제 내역 등을 저장해야 한다.
    - 어플리케이션에 생성된 kafka 토픽: 로그인 기록, 사용자의 결제 내역 등
2. 이 어플리케이션 개발자는 사용자가 어떤 카드를 사용하여 얼마나 결제했는지에 대한 통계를 내기 위해 저장한다고 가정한다.
    - 이 때 카드 종류가 파티션

### **정리**

1. **토픽**: 결제 내역
2. **파티션**
    - 삼성카드
    - 신한카드
    - 현대카드 …
3. **각 파티션 내 데이터**
    - **삼성카드 파티션**: 삼성카드로 결제한 카드 정보들 (예: 거래 ID, 사용자 정보, 결제 금액 등)
    - **신한카드 파티션**: 신한카드로 결제한 카드 정보들
    - **현대카드 파티션**: 현대카드로 결제한 카드 정보들

위와 같이 된 Kafka가 있다면 서버에서는 특정 메소드가 실행되어 프로듀서로 보내지는 데이터들은 card_process 토픽으로 보낸다는 메소드로 작성해주면 된다.

```java
// 자바로 표현한다면 이런식
public void sendCardData(String jsonData) {
        // 특정 토픽에 대한 프로듀서 메서드
        String topic = "card_process";
        
        // 메시지를 생성하고 토픽으로 발송
        ProducerRecord<String, String> record = new ProducerRecord<>(topic, jsonData);
        
        producer.send(record, new Callback() {
            @Override
            public void onCompletion(RecordMetadata metadata, Exception exception) {
                if (exception != null) {
                    exception.printStackTrace();
                } else {
                    System.out.println("Message sent to topic " + metadata.topic() + " partition " + metadata.partition());
                }
            }
        });
    }
```
